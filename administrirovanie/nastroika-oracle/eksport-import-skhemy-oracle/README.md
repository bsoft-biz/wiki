# Экспорт/Импорт схемы oracle

## Возможности uniVersions.

Изменения в программе заключаются в изменениях во внешнем виде и стиле навигации, в доработке механизма исполнения скриптов SQL и формата сохранения списка ошибок этих скриптов, а также в появлении нескольких новых разделов – работа с табличными пространствами, управляемый экспорт/импорт, сравнение схем Oracle.

**Изменения во внешнем виде** бросаются в глаза сразу после запуска приложения un4Versions – в левой части окна появилось меню с цветными значками, позволяющее быстро и удобно переключаться между разными страницами приложения, предназначенными для решения различных задач.

В верхней части меню есть две кнопки с буквами «A» и «X» – первая включает/выключает режим автоматического скрытия меню при установке фокуса ввода на выбранную страницу, вторая просто скрывает меню. Снова показать меню на экране можно клавиатурной комбинацией &lt;Ctrl&gt;+&lt;~&gt; \(контрол-тильда\).

В нижней части меню есть два чек-бокса \(галочки\), с надписями «Окно ошибок» и «Показать закладки». Первый включает/выключает видимость панели со списком ошибок выполнения скрипта, расположенную в нижней части окна приложения. Второй включает/выключает ярлычки страниц \(закладки\), приводя приложение к старому способу навигации.

## Доработка механизма исполнения скриптов SQL.

Заключается в поддержке вложенных скриптов \(имя файла указывается после символа “@”\), в возможности выполнения скриптов с правами супервизора \(чек-бокс «Выполнять как SYS»\) и в новом формате сохранения списка ошибок – теперь они хранятся в табличной форме, каждая ошибка имеет свой номер, дату и время возникновения, и кроме сообщения об ошибке и исполняемого выражения сохраняется также и строка соединения, активного в момент возникновения ошибки. Список ошибок можно сохранить в файл формата xml или pak \(упакованный xml\), его также можно загрузить заново из ранее сохраненного файла.

На странице исполнения скриптов SQL появилась кнопка с изображением папки зеленого цвета – эта кнопка позволяет одним кликом мышки загрузить скрипт на создание схемы un4public, расположенный в специальной папке относительно каталога запуска приложения \(script un4public un4public.sql\). При этом автоматически включается чек-бокс «Выполнять как SYS», и благодаря поддержке вложенных скриптов этот скрипт может быть выполнен нажатием на кнопку «Выполнить скрипт».

## Страница работы с табличными пространствами.

Позволяет определить, какие предопределенные табличные пространства уже созданы на выбранном сервере \(кнопка «Обновить»\), а также позволяет создать недостающие, предварительно настроив их размеры и проставив соответствующие чек-боксы \(кнопка «Создать выбранные»\). При нажатии на эту кнопку формируется скрипт на создание табличных пространств, который помещается в окно выполнения скриптов SQL, и происходит переключение на эту страницу приложения \(чек-бокс «Выполнять как SYS» включается автоматически\). Больше никаких действий не происходит, выполнение скрипта запускается пользователем вручную при необходимости.

Кнопка «Стандарт» возвращает предустановленные значения размеров табличных пространств, которые еще не созданы на выбранном сервере.

Изменение размеров уже созданных табличных пространств, также как и другие манипуляции над ними, не входит в возможности описываемого приложения.

## Страница управляемого экспорта/импорта.

Позволяет легко экспортировать и импортировать схемы Oracle методом «Data Pump», при этом есть такие дополнительные возможности, как:

* экспорт полной, отфильтрованной по условиям или пустой БД \(только структуры\)
* импорт полной, отфильтрованной по условиям или пустой БД \(только структуры\)
* создание скрипта на импорт структуры
* компиляция всех PL/SQL объектов перед экспортом и после импорта
* сохранение \(перед экспортом\) списка объектов и их состояний в отдельной таблице
* сравнение \(после импорта\) состояния всех объектов с сохраненным заранее списком

Импорт методом «Data Pump» не требует создания схемы заранее, она создается в процессе импорта с теми же привилегиями, что и экспортированная схема-оригинал. Важно учитывать, что имена используемых табличных пространств должны совпадать на сервере-источнике \(откуда выполняется экспорт\) и целевом сервере \(куда выполняется импорт\).

При смене имени схемы в процессе импорта приложение un4Versions автоматически устанавливает пароль на схему, совпадающий с новым именем схемы.

Экспорт данных с фильтром позволяет решать такие часто встречающиеся задачи, как «создание новой схемы на основании имеющейся» и «резка базы по дате и nrset с сохранением отдельных документов»

Для работы этой страницы на схеме UN4PUBLIC выбранного сервера должны присутствовать пакеты PG\_EXIM и UN$EXIM \(последние версии обоих датированы 19.04.2008\), и на них должны быть созданы одноименные общие синонимы.

В верхней части страницы экспорта/импорта расположены 4 поля ввода: «Схема-источник», «Oracle Directory», «Файл экспорта» и «Новая схема». После подключения к нужному серверу поля «Схема-источник» и «Oracle Directory» можно выбрать из списка, нажав кнопочку «…» справа от поля ввода. Поле «Oracle Directory» можно не заполнять – в этом случае будет использован каталог DATA\_PUMP\_DIR, который создается при установке сервера Oracle и поэтому присутствует практически на всех серверах.

Ниже расположен набор страниц с закладками «Действия», «Сравнение объектов», «Фильтр на таблицы», «Резка базы», «Фильтр на Docs» и «Фильтр на Univers».

### Страница «Действия».

На странице «Действия» расположены три ряда кнопок, запускающих те или иные действия:

«Скомпилировать ист.» - скомпилировать инвалидные PL/SQL объекты на схеме-источнике

«Создать таблицу объектов» - на схеме-источнике создать таблицу состояний всех объектов

«Скомпилировать нов.» - скомпилировать инвалидные PL/SQL объекты на схеме-приемнике

«Сравнить объекты» - получить результат сравнения состояний объектов одним сообщением

«Экспорт всей схемы» - запустить процедуру экспорта полной базы данных

«Экспорт только структуры» - запустить процедуру экспорта структуры

«Экспорт по фильтру» - запустить процедуру экспорта базы данных с применением фильтра

«Подключиться…» - открыть окно слежения за ранее запущенным заданием экспорта/импорта

«Импорт всей схемы» - запустить процедуру импорта полной базы данных

«Импорт только структуры» - запустить процедуру импорта структуры

«Импорт по фильтру» - запустить процедуру импорта базы данных с применением фильтра

«Скрипт на импорт» - в указанном каталоге Oracle создать скрипт на создание структуры

### Страница «Сравнение объектов».

На странице «Сравнение объектов» расположен грид \(таблица\), в котором можно наблюдать результат сравнения состояний объектов схемы до экспорта и после импорта, а также ряд чек-боксов в верхней части страницы и кнопка «Обновить» внизу страницы.

Чек-бокс «Контроль вручную» включает/выключает отображение результатов сравнения.

Чек-бокс «Отличающиеся» включает/выключает отображение объектов, состояние которых изменилось

Чек-бокс «Исчезнувшие» включает/выключает отображение объектов, которых нет в схеме-приемнике

Чек-бокс «Появившиеся» включает/выключает отображение объектов, которых нет в схеме-источнике

Чек-бокс «Устаревшие» включает/выключает отображение объектов, считающихся устаревшими

Кнопка «Обновить» пересчитывает содержимое грида \(таблицы\), если отображение включено.

Чтобы использовать кнопку "Сравнить выделенные в Beyond Compare", необходимо внести изменения в реестр ОС windows. Для этого есть спец. файл правки реестра, который можно [скачать здесь](https://yadi.sk/d/ZiHI9F013XDSjc).

### Страница «Фильтр на таблицы».

На странице «Фильтр на таблицы» расположен грид \(таблица\), в котором можно наблюдать и исправлять установленный фильтр на таблицы БД, используемый при экспорте по фильтру и импорте по фильтру, чек-бокс «Контроль вручную» сверху и несколько кнопок в нижней части страницы.

Чек-бокс «Контроль вручную» включает/выключает отображение списка таблиц и их фильтров.

В первом столбце «Имя таблицы» указывается имя таблицы Oracle, данные которой нужно экспортировать. Не перечисленные в этом списке таблицы будут экспортироваться без данных в режиме экспорта по фильтру.

Во втором столбце «Выражение фильтра» можно указать выражение \(предикат\), выбирающий группу записей таблицы, подлежащих экспорту в режиме экспорта по фильтру. Если это поле не заполнено, экспортироваться \(в этом режиме\) будет вся таблица.

Кнопка «Заполнить все» вызывает процедуру, заносящую в список все таблицы указанной схемы.

Кнопка «Обновить» пересчитывает содержимое грида \(таблицы\), если отображение включено.

Кнопка «Очистить» вызывает процедуру, очищающую список таблиц.

Кнопка «Заполнить главные» вызывает процедуру, заносящую в список некоторые таблицы указанной схемы. Полученный таким образом фильтр позволяет создавать новые схемы на основании имеющихся.

Поле ввода «Имя процедуры» позволяет вызвать этой кнопкой другую процедуру взамен стандартной.

### Страница «Резка базы».

На странице «Резка базы» расположены поля ввода даты начала отсекаемого периода, списка номеров документов и списка номеров NRSET, чек-бокс \(галка\) «Использовать функцию GET\_NRSET\(\)», а также кнопка «Установить фильтр для резки».

В поле «Дата начала оставляемого периода» можно ввести дату отсечения для резки базы по дате.

Дата отсечения используется только в том случае, если установлен чек-бокс \(галка\) слева от даты.

Список номеров документов позволяет перечислить номера документов, которые надо сохранить вне зависимости от накладываемого фильтра на дату и NRSET \(это могут быть, к примеру, контракты\).

Список номеров NRSET позволяет перечислить определенные номера NRSET, по которым надо экспортировать данные. Фильтр по NRSET применяется только при непустом значении этого поля.

Чек-бокс \(галка\) «Использовать функцию GET\_NRSET\(\)» относится к фильтру по NRSET и указывает, что в выражение фильтра надо подставлять не само значение NRSET, а результат выполнения функции GET\_NRSET\(NRSET\). Это может использоваться в случаях сложных номеров NRSET, хранящих несколько признаков в одном значении.

Кнопка «Установить фильтр для резки» запускает процедуру установки фильтра на таблицы согласно введенным значениям, и затем переключает отображение на страницу «Фильтр на таблицы» и обновляет содержимое списка таблиц и выражений фильтра.

### Страница «Фильтр на Docs».

На странице «Фильтр на Docs» расположено поле ввода выражения фильтра, который надо наложить на таблицу TMDB\_DOCS и связанные с ней дочерние таблицы \(спецрегистры\), поле ввода «Имя таблицы» и кнопка «Установить фильтр на Docs».

В поле «Имя таблицы» можно ввести имя другой таблицы, на которую нужно наложить указанный фильтр \(с фильтрацией связанных с ней дочерних таблиц\)

Таблицы считаются связанными с TMDB\_DOCS \(или другой таблицей, отдельно указанной в поле «Имя таблицы»\), если между ними существует ограничение ссылочной целостности с каскадным удалением.

Кнопка «Установить фильтр на Docs» запускает процедуру установки фильтра на таблицы согласно введенным значениям, и затем переключает отображение на страницу «Фильтр на таблицы» и обновляет содержимое списка таблиц и выражений фильтра.

**Внимание! Чтобы файл дампа был корректным и последующий импорт выполнялся без ошибок, необходимо оставить хотя бы один документ при экспорте схемы по фильтру. \(иначе могут быть проблемы при импорте, ошибка пакета для импорта\).**

### Страница «Фильтр на Univers».

На странице «Фильтр на Univers» расположен грид \(таблица\), в котором можно ввести список разделов универсального справочника, которые надо экспортировать \(и не экспортировать неперечисленные\).

Здесь можно сформировать выражение фильтра на универсальный справочник и связанные с ним дочерние таблицы \(карточки\), которое затем попадет в общий список выражений фильтра на таблицы.

Практика показала, что при создании новой схемы на основании имеющейся лучше выгружать универсальный справочник полностью, поэтому описываемая таблица теряет свою актуальность.

## Порядок действий при экспорте/импорте базы \(возможно, с фильтром\):

* Кнопки «Скомпилировать ист.», «Создать таблицу объектов».
* Настроить фильтр \(при необходимости\) любым из описанных выше способов.
* Кнопка «Экспорт всей схемы», «Экспорт только структуры» или «Экспорт по фильтру».
* Дождаться окончания экспорта, закрыть окно слежения за заданием.
* Подключиться \(при необходимости\) к серверу импорта
* Указать \(при необходимости\) имя новой схемы \(куда импортировать\)
* Кнопка «Импорт всей схемы» \(или другая в той же строке, по смыслу задачи\)

Хинт по применению кнопок, вызывающих действия над базой данных: если при нажатии на кнопку удерживать клавишу &lt;Shift&gt;, то действие не выполняется, а в окно выполнения скриптов помещается скрипт на выполнение соответствующего действия, и происходит переключение на окно выполнения скриптов. Это позволяет пользователю увидеть, какой вызов соответствует той или иной команде, и при необходимости откорректировать его, а затем выполнить кнопкой «Выполнить скрипт».

## Страница "Сравнение схем".

Страница сравнения схем позволяет сравнивать похожие схемы Oracle, загружая их в левую и правую части окна сравнения схем. Загруженную схему можно сохранить в файл \(формата xml или pak – упакованный xml\), а затем загрузить из такого файла, и использовать для сравнения с реальной схемой.

В левой части страницы сравнения схем расположено «дерево» объектов, где по типам сгруппированы анализируемые объекты схем – таблицы, представления, типы и т.п.

В верхней части страницы сравнения схем находится общая панель инструментов, а под ней – левая и правая части, являющиеся взаимозаменяемыми равноправными объектами сравнения. Каждая из этих частей содержит свою панель инструментов, список элементов, составляющих выделенный в «дереве» объект, и панель описания выделенного элемента, а также панель с указанием источника данных.

На общей панели инструментов расположены следующие кнопки:

Кнопка «Обновить данные для сравнения» перечитывает содержимое обеих частей сравнения

Кнопка с выпадающим меню для выбора фильтра объектов в «дереве» отображает выбранный фильтр

Кнопка «Скрипт на все различия \(справа налево\)» формирует скрипт на странице выполнения скриптов

Кнопка «Скрипт на все различия \(слева направо\)» формирует скрипт на странице выполнения скриптов

Кнопка «Скрипт на выделенный элемент \(справа налево\)» работает для выбранного в «дереве» объекта

Кнопка «Скрипт на выделенный элемент \(слева направо\)» работает для выбранного в «дереве» объекта

Кнопка «Показать детализацию элементов» включает подробное описание элементов объекта

Кнопка «Скрыть детализацию элементов» выключает подробное описание элементов объекта

Кнопка «Сравнить выделенные в Beyond Compare» позволяет использовать внешнее приложение

На каждой из частей сравнения панель инструментов содержит следующие кнопки:

Кнопка «Загрузить с сервера…» позволяет загрузить реальную схему Oracle из подключения

Кнопка «Загрузить из файла…» позволяет загрузить сохраненную ранее схему Oracle

Кнопка «Обновить данные для схемы» перечитывает содержимое одной части сравнения

Кнопка «Сохранить в файл…» позволяет сохранить загруженную схему в файл

Кнопка «Очистить» очищает содержимое одной части сравнения

## Хинты по формированию скриптов:

При формировании скрипта на разницу в обычном режиме старое содержимое страницы выполнения скрипта удаляется, и она заполняется вновь сгенерированным текстом и появляется на экране взамен страницы сравнения схем. Но при удерживании клавиши &lt;Shift&gt; сгенерированный скрипт добавляется к уже имеющемуся, и на экране остается страница сравнения схем.

При формировании скрипта на разницу в обычном режиме происходит добавление новых объектов и элементов и модификация уже имеющихся, но удаление отсутствующих \(возможно, устаревших или нестандартных\) объектов и элементов не производится. Но при удерживании клавиши &lt;Ctrl&gt; сгенерированный скрипт будет содержать и команды на удаление таких объектов.

## Ключи командной строки:

| Запуск приложения с активацией страницы сравнения схем | \&gt; un4Versions.exe /compare |
| :------------- |:-------------:| 
| Запуск приложения с загрузкойсхемы Oracle с сервера | \&gt; un4Versions.exe /compare src= un4@Ora1 |
| Запуск приложения с загрузкой схемы Oracle из файла | \&gt; un4Versions.exe /compare src= un4std.pak |
| Запуск приложения с загрузкой  двух схем Oracle из разных источников | \&gt; un4Versions.exe /compare src=un4std.pak tgt=un4@Ora1 |

[Описание ошибок](opisanie-oshibok-vozmozhnykh-pri-rabote-s-un4versions.md), возможных при работе с un4Versions и способы их устранения.

Работа с программой [UniVersions из командной строки](rabota-s-programmoi-universions-iz-komandnoi-stroki.md).

Резервное копирование базы - [BackUp при помощи uniVersions](backup-pri-pomoshi-universions.md).

