# Универсальный отчет \(RSE\)

`Свойства Нового Универсального отчета`

| **Название** | **Тип** | **Принимаемое значение** | **Описание** |
| :--- | :---: | :--- | :--- |
| Caption | String |  | Подпись окна параметров отчета |
| DLL ID | Integer | 4201 | Идентификационный номер DLL |
| OldStyleListBaza | Memo |  |  |
| OldStyleListCorr | Memo |  |  |
| OraFunction | String | UN$G\_RG1P12.GetQuery | Процедура PL/SQL генерации результирующего набора записей |
| Report ID | String | 12 | Идентификационный номер отчета в DLL |
| RseAlias | String | SQ |  |
| RseFieldsAbove | Memo |  |  |
| RseFieldsBaza | Memo |  | Список доступных и выбранных полей раздела Filtru de baza |
| RseFieldsCorr | Memo |  | Список доступных и выбранных полей раздела Filtru Corespondent |
| RseSoldRulajTmplOrder | String | IA,IP,DT,CT,FA,FP | Указывает, какие из категорий Sold Initial Dt, Ct, Rulaj Dt, Ct, Sold Final Dt, Ct используются в отчете и порядок появления их в шаблоне |
| Template | String | RG1p12.vts | Шаблон, используемый для генерации отчета |
| RepWindow | Memo |  | Текст, содержащий настройки окна параметров отчета: отображение / скрытие элементов управления, установка значений по умолчанию, включение / выключение флажков |
| RseSumaCantTmplOrder | Memo |  | Указывает, какие из категорий Cant, Suma, SumaVal используются в отчете и порядок появления их в шаблоне |

**Чтобы увидеть изменения универсально отчета , после изменения свойств в конфигураторе, нужно перезапустить программу.**

**Описание полей RSE, которые могут быть включены в отчет**

Поля описываются группой строк, по одной на каждое поле.

Каждая строка состоит из нескольких выражений, разделенных запятыми.

Выражения должны содержать следующие значения:

Первое - значение уровня в древообразном списке \(0 - самый верхний уровень\).

Второе - тип поля \(grp, const, an, ref, agr\) \(см. ниже\).

grp - фиктивное поле, служащее для визуальной группировки других полей

const - поле, значением которого является константа \(седьмое выражение\)

an - поле, значением которого является поле запроса \(седьмое выражение\)

```text
   \(при отсутствии седьмого выражения его роль играет пятое выражение\)
```

ref - поле, ссылающееся на другое поле \(см. ниже\)

agr - поле, содержащее числовое значение, допускающее использование

```text
    агрегатных функций sum, count, max, min, avg \(седьмое выражение\)
```

Третье - заголовок поля, отображаемый в элементах интерфейса.

Четвертое - набор флагов \(строка, могущая включать буквы ACDFGILMNOPQRSTUWZ\).

После буквы могут указываться дополнительные данные флага в фигурных скобках.

Описание каждого флага в отдельности см. ниже

Для типа "grp" список полей на этом заканчивается.

Пример:

0,grp,"Period",S

Для остальных типов выражения должны содержать следующие значения:

Пятое - имя поля в SQL запросе

Шестое - текст функции итогов, используемой в шаблоне \(sum, count, max, min, avg\)

Начиная с седьмого выражения, их смысл зависит от типа поля.

Поля типа "const":

Седьмое - значение поля, константное выражение.

При его отсутствии его роль играет имя поля \(пятое выражение\)

Примеры:

1,const,"Begin Date",SD,DATEBEGIN,,"'01.08.2001'"

0,const,"Product ID",,PRODCODE,,5466

0,const,"Состояние",S,OK

Поля типа "an":

Седьмое - поле запроса или выражение на языке SQL.

При его отсутствии его роль играет имя поля \(пятое выражение\)

Примеры:

0,an,"Object ID",,OBJECTID,,CTSC

0,an,"Product ID",,PROD

Поля типа "ref":

Седьмое - поле запроса, используемое как ключ связки для вычисления функции

Восьмое - тип функции \(Q, U, S, G, M\)

Q - произвольный SQL запрос

U - ссылка на поле справочника UNIVERS

S - ссылка на поле справочника SYSS

G - ссылка на элемент группировки SYSGRP

M - ссылка на атрибут маски STRGRP

Девятое и остальные - параметры функции, зависят от типа функции:

Тип "Q":

Девятое - текст запроса в кавычках, значение которого и будет значением поля

Тип "U":

Девятое - поле справочника UNIVERS, значение которого и будет значением поля

Тип "S":

Девятое - поле справочника SYSS, значение которого и будет значением поля

Десятое - значение поля TIP справочника SYSS

Одиннадцатое - значение поля COD справочника SYSS

Тип "G":

Девятое - класс группировок \(TMS\_SYSGR.ID0\) - может быть задан явно \(числом\)

или неявно \(строкой\). В последнем случае класс группировок вычисляется как

NVL\(SYS\_CONTEXT\('ENVUN4','ID0$'\|\|:CLASS\),0\) \(здесь :CLASS - данная строка\)

Десятое - уровень группировки \(0..5\), по умолчанию 0 \(может быть опущен\)

Ненулевое значение \(1..5\) означает вывод названия узла указанного уровня,

содержащего элемент справочника, код которого содержится в поле, указанном

в седьмом выражении.

Нулевое или отсутствующее значение означает вывод названия конечного узла,

то есть узла с максимальным уровнем вложенности, содержащим этот элемент.

Тип "M":

Девятое - номер атрибута \(1..29\). Если он не указан, выводится STRGRPCOD

Десятое - поле: 0 или пусто означает CLC\_ID\_ITEM, 1 - ID\_MASK, 2 - ID\_ITEM

В случае типа "Q" седьмое выражение может содержать несколько полей,

разделенных запятыми \(тогда весь список надо взять в кавычки\),

а может и не содержать значений вовсе.

При использовании типа "G" в универсальном отчете можно указывать класс

группировок как одно из значений SC, DEP или SC1 - соответствующие

сисконтексты устанавливаются перед построением отчета на основании

выбранных классов группировок каждого уровня аналитики на панели фильтра.

Примеры:

1,ref,"Pret. Fapt",S,PRET\_FAPT,,"CANT\_FAPT,SUMA\_FAPT",Q,"DECODE\(CANT\_FAPT, 0, 0, SUMA\_FAPT / CANT\_FAPT\)"

1,ref,"Object Code",S,CODVECHI,,CTSC,U,CODVECHI

1,ref,"Наименование",S,ATRIBUT,,CTSC,S,DENUMIREA,C,4

1,ref,"Новая/Оборотная",S,COD\_N\_O,,STRSC,S,DENUMIREA,T,102

2,ref,"SC\|Узел",MW{20},SC\_NODE,,SC,G,SC

2,ref,"SC\|Группа",MW{20},SC\_NODE1,,SC,G,SC,1

2,ref,"SC\|Подгруппа",MW{20},SC\_NODE2,,SC,G,SC,2

2,ref,"SC\|Маска",MW{20},SC\_MASK,,SC,M

2,ref,"SC\|Св-во 1",MW{20},SC\_MASK1,,SC,M,1

2,ref,"SC\|Св-во 2",MW{20},SC\_MASK2,,SC,M,2

2,ref,"SC\|Св-во 3",MW{20},SC\_MASK3,,SC,M,3

Поля типа "agr":

Седьмое - название агрегатной функции SQL \(sum, count, max, min, avg\)

При его отсутствии поле работает как поле типа "an"

Описание флагов

Вообще символ флага может указываться в любом регистре, но отдельные флаги

\(такие, как C и G\) интерпретируют нижний регистр как обратную функцию

S \(Selected\) означает, что поле сразу после инициализации включено в запрос

Для групповых полей этот признак включает в запрос все поля группы

C \(Collapsed\) означает, что поле будет отображено со свернутым поддеревом

Тот же флаг в нижнем регистре \(c\) означает обратное: развернуть поддерево

G \(Grouped\) означает, что поле будет иметь признак группировки в шаблоне

Тот же флаг в нижнем регистре \(g\) означает обратное: без группировки

D \(Disabled\) означает, что значение флага Selected нельзя будет изменять

Флаги SCG содержат первоначальные значения свойств поля, которые пользователь

может изменять в процессе настройки запроса \(за исключением свойства Selected,

которое при включенном флаге Disabled пользователю менять нельзя\)

Для реализации отчетов типа Master/Detail поля могут быть отнесены к одной

из трех категорий:

* Master-поля \(все столбцы располагаются в левой части отчета\)
* Агрегатные поля \(все столбцы располагаются в средней части отчета\)
* Detail-поля \(все столбцы располагаются в правой части отчета\)

Master-поля выводятся только на Master-строках, Detail-поля выводятся только

на Detail-строках, а агрегатные поля выводятся на всех строках отчета.

M \(Master\) означает, что поле входит в Master поднабор полей \(столбцы слева\)

O \(Master only\) означает, что поле не входит в Detail поднабор полей

A \(Aggregate\) означает, что поле является агрегатным \(столбцы посередине\)

Эти три флага применяются при построении Master/Detail отчёта на одном наборе

данных. Флаг M указывают у полей, по которым производится группировка строк,

и у числовых показателей \(сумма, количество\). Для выделения последних надо

указать также флаг A, в этом случае поле будет присутствовать и в Detail

строках данных. Флаг G у полей с флагами MA означает, что поле отображается

и в Master строках, показывая сумму поля по текущей группировке.

P \(Protected\) означает, что поле определено в исходниках программы и не может

быть удалено, переименовано и т. п., так как оно задействовано в алгоритмах.

По отношению к этому полю разрешены только изменения его состояния.

Флаг P устанавливается программно, пользователю он не нужен и не доступен.

R \(Aggregate referential\) используется только с полями типа ref и означает,

что SQL-выражение является агрегатной функцией. Тип ссылки должен быть Q.

Z \(Z-A sort order\) указывает, что сортировка по этому полю должна выполняться

в порядке убывания значений.

* Далее идут флаги, использующие дополнительную информацию в фигурных скобках,

  указываемую непосредственно после символа флага: XX{x}XXX{xx,xxx,xxx}XX

F \(Filter\) содержит фильтр значений поля - то условие, которое будет включено

в Where clause при включении этого поля в набор \(установлен флаг S\)

Этот фильтр применяется на внешнем уровне запроса, сформированного RSE

I \(Input filter\) содержит фильтр значений поля - то условие, которое будет

включено в Where clause на внутреннем уровне запроса. Этот фильтр применяется

вне зависимости от флага S \(то есть применяется ВСЕГДА\)

Q \(Query type\) это условная информация, используемая для визуальной правки

входного фильтра \(способ пользовательского ввода значений фильтра\).

В фигурных скобках указывается строка, первый символ которой должен быть

одним из символов USQACILD. Значение символов следующее:

U - поле фильтруется как список кодов из универсального справочника,

```text
  фильтр указывается через запятую: Q{U,O,R} или Q{U,P,'2111,2161'}
```

S - поле фильтруется как список кодов из системного справочника,

```text
  фильтр указывается через запятую: Q{S,Y,201}
```

Q - поле фильтруется как список кодов из произвольного запроса. Запрос

```text
  может содержать произвольное количество полей, но среди них обязательно

  должны присутствовать два поля - код и текст выпадающего справочника:

  Q{Q,"SELECT ID1,TEXT,P1,P2 FROM VMS\_UNIVTREE1 WHERE ID0=1",TEXT,ID1}
```

A - абстрактный фильтр. Поле фильтруется выражением, полученным от склейки

```text
  имени поля и введенной пользователем строки. Пример для поля с именем DT,

  типом фильтра Q{A} и введенной строки "=5211": фильтр будет "DT =5211"
```

C - поле фильтруется как счет из Плана счетов. Пример для поля с именем DT,

```text
  типом фильтра Q{С} и введенной строки "22 52": фильтр будет

  "\(DT BETWEEN 2200 AND 2299 OR DT BETWEEN 5200 AND 5299\)"
```

I - поле фильтруется как одно из значений, перечисленных пользователем.

```text
  Пример для поля с именем DT, типом фильтра Q{I} и введенной строки

  "2111,2161": фильтр будет "DT IN\(2111,2161\)"
```

L - поле фильтруется как строка, содержащая введенное пользователем значение.

```text
  Пример для поля с именем DENUMIREA, типом фильтра Q{L} и введенной строки

  "SRL": фильтр будет "DENUMIREA LIKE '%SRL%'"
```

D - поле фильтруется как дата, удовлетворяющая выбранному пользователем

```text
  периоду
```

Заранее задать значение фильтра можно, указав его как значение флага U.

Примеры комбинаций флагов: "Q{U,O,R}U{1297,1299}", "Q{C}U{22 52}".

Для типа D: "Q{D}U{31.12.2003}" или "Q{D}U{01.01.2003-31.12.2003}" - можно

указать как одну дату, так и период.

N \(Null value\) содержит "нулевое значение" - вместо значения NULL

Для полей типа DATE обязательно вставлять флаг N{'1/1/1'}

L \(Link list\) содержит список полей, от которых зависит данное поле

V \(Variations\) содержит список названий, соответствующих переводам E, M, R

W \(Width\) содержит ширину \(в символах\) столбца по умолчанию

T \(Format\) содержит формат ячейки по умолчанию

U \(User data\) содержит произвольные данные, которые нужны программисту

Флаги FIQNLVWTU содержат дополнительную информацию в фигурных скобках.

Например, для выделения строк, содержащих CTDATA='24.04.2002' можно указать флаги как SF{CTDATA='24.04.2002'}. Нулевое зн. используется при формировании

связей Master/Detail в функции NVL, например: NVL\(CONT, 0\) = NVL\(:CONT, 0\)

Это важно для полей типа DATE, чтобы в функции NVL использовалось значение, которое без ошибок приводится к типу DATE \(например, '1/1/1'\)

Флаг L используется для установления зависимостей между полями, чтобы при включении одного поля включались и некоторые другие, от которых оно зависит.

Например, при включении суммы в валюте удобно, чтобы чразу включалась и сама валюта. Это записывается для поля SUMAVALDT как L{VALUTADT}. Тогда при

выключении поля VALUTADT выключится и поле SUMAVALDT. Полей в скобках может быть несколько, в этом случае они разделяются запятыми без пробелов.

Флаг V определяет или переопределяет названия поля RSE, соответствующие каждому из трех языков программы \(без него все три названия одинаковы\)

Флаги W и T используются только при автоматической генерации шаблона.

Значение флага U доступно программисту через property AnsiString UserData.

Примеры:

1,agr,"Cantitatea",SD,CANT\_PROD

1,agr,"Suma Plan",SD,SUMA\_PLAN,SUM

Комплексные примеры:

Пример группы из двух параметров, задающих календарный период:

0,grp,"Period"

1,const,"Begin Date",SD,DATEBEGIN,,"'01.08.2001'"

1,const,"Final Date",SD,DATEFINAL,,"'31.08.2001'"

Пример свернутой группы параметров с вершиной на запрещенном поле кода объекта:

0,an,"Object ID",СD,CTSC

1,ref,"Object Code",S,CODVECHI,,CTSC,U,CODVECHI

1,ref,"Object UM",S,UM,,CTSC,U,UM

1,ref,"Object Text",S,CTSCT,,CTSC,U,DENUMIREA\_\_1

Пример двух наборов параметров \(Plan и Fapt\) с похожими реквизитами:

0,grp,"Plan",S

1,agr,"Cant Plan",S,CANT\_PLAN

1,agr,"Pret Plan",S,PRET\_PLAN

1,agr,"Suma Plan",SD,SUMA\_PLAN,SUM

0,grp,"Fapt",S

1,agr,"Cant Fapt",S,CANT\_FAPT

1,ref,"Pret Fapt",S,PRET\_FAPT,,,Q,"DECODE\(CANT\_FAPT, 0, 0, SUMA\_FAPT / CANT\_FAPT\)"

1,agr,"Suma Fapt",SD,SUMA\_FAPT,SUM

**В конфигураторе, функцию, возвращающую varchar2, varchar или char нужно обязательно помещать внутрь substr\(pkg\_name.funk\_name\(\),1,длина\_строки\).**  
**От параметра длина\_строки будет зависеть размер varchar2 по которому УО строит индекс.**  
_Для функций возвращающих другие типы пока не проверялось._

