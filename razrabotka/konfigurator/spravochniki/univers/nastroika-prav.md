# Настройка прав

Чтобы разрешить пользователю удаление из универс:  
`un4public.envun4.EnvSetValue('univers_allow_del', 1);`

Чтобы полностью запретить вставку в универс:  
 `un4public.envun4.EnvSetValue('univ_ins_deny', 1);`

## XUNIVLOCK {#HXUNIVLOCK}

На таблице `TMS_UNIVERS` есть триггер, который проверяет права текущего пользователя на модификацию того раздела справочника, к которому относится изменяемая запись.

Триггер называется `TMS_UNIVERS_TRLOCK`, он использует процедуру `UNIVLOCK_CHECKTIP` для проверки прав доступа.

На таблицах `TMS_AFX`, `TMS_MPT`, `TMS_MUNC`, `TMS_ORG` и еще на нескольких, связанных с `TMS_UNIVERS` каскадным удалением, тоже стоят триггера, проверяющие те же права. Эти триггера используют процедуру  `UNIVLOCK_CHECKCOD`, которая по коду вычисляет значения TIP и GR1 и вызывает для них процедуру `UNIVLOCK_CHECKTIP`. Так сделано потому, что в этих таблицах неизвестны значения TIP и GR1, приходится делать проверку

в два действия.

Суть проверки сводится к оценке двух факторов:

1. Запрещен ли данный раздел справочника?

2. Если да, то нет ли у пользователя особых прав?

Запрещение модификации реализовано следующим образом.

Есть таблица `TMS_UNIVLOCK`, в ней - три поля:

`TIP VARCHAR2(1)`

`GR1 VARCHAR2(5)`

`PERSON VARCHAR2(50)`

Каждая запись этой таблицы объявляет запрет на изменение какой-то части справочника Univers - на пару значений TIP и GR1 или на весь TIP \(если GR1 пуст\).

Поле PERSON служит для указания сотрудника, ответственного за изменения этого раздела справочника.

На этой таблице есть триггер `TMS_UNIVLOCK_TR`, позволяющий вносить в нее изменения только пользователю с правами администратора. Для запрета модификации какого-то раздела справочника надо внести новую запись в эту таблицу.

Особые права пользователей реализованы следующим образом.

Есть временная таблица `XUNIVUNLOCK`, в ней - пять полей:

`TIP VARCHAR2(1)`

`GR1 VARCHAR2(5)`

`I NUMBER(1)`

`U NUMBER(1)`

`D NUMBER(1)`

Эта таблица при каждом соединении вначале пуста, но процедура инициализации рабочего окружения пользователя может вносить сюда какие-то записи. Каждая запись означает права пользователя на внесение изменений в соответствующий раздел справочника, несмотря на общий запрет модификации. Пользователь, которому нужно дать такие права, должен в своей секции Администратора иметь свойство RunSQL, в котором будет примерно такие строки:

```sql
BEGIN 
INSERT INTO VUNIVUNLOCK (TIP,GR1) VALUES ('O','R'); 
END;
```

В этом примере пользователю даются права на **любую** работу со списком сотрудников \(включая их карточки\).

```sql
BEGIN
INSERT INTO VUNIVUNLOCK (TIP,GR1) VALUES ('O','R',0,1,0);
END;
```

В этом примере пользователь получает право вносить изменения, но не может добавлять либо удалять сотрудников.

Важно заметить, что вставка выполняется не в таблицу `XUNIVUNLOCK`, а во вьюшку `VUNIVUNLOCK`. 

Эта вьюшка при вставке исключает дублирование записей, это важно при повторном выполнении `RunSQL` во время обновления настроек \(F5\)  
  
Для разрешения/запрета пользователю выполнения определённых операций, необходимо явно указать это цифровым значением   
1-разрешить   
любое другое - запретить   
null или отсутствие параметра считается разрешением

