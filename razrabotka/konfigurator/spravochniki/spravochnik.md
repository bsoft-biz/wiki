# Справочник

  
**Типы справочников:**

·         Справочник элементов аналитического учета \(Univers\)

·         Справочник произвольных элементов \(SysS\)

·         План счетов бухгалтерского учета \(PDC\)

·         Валюты \(денежные единицы различных государств\)

·         Единицы измерения

**Старое, но мало кому известное свойство документа: SQL\_UNIV**

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Свойство SQL\_UNIV ставится на секции документа и позволяет задавать фильтр на справочник Univers в зависимости от введенных значений.

Это свойство \(как правило, типа Memo\) должно содержать PL/SQL код, который будет выполняться всякий раз при выпадении справочника Univers непосредственно из панели документа \(из поля шапки, грида или др.\)

Назначение этого механизма в том, чтобы устанавливать значения контекстных переменных значениями полей документа, и использовать эти переменные в тексте SQL-запроса справочника \(например, для фильтра\)

Пример:

::::::::::::::::::::

BEGIN

ENVUN4.SetEnvValue\('DOC12345\_DEST',:DTDEP\);

ENVUN4.SetEnvValue\('DOC12345\_EXPED',:CTDEP\);

END;

/\*

DTDEP=indoc\_m\_dtdep

CTDEP=indoc\_m\_ctdep

\*/

::::::::::::::::::::

В настройках выпадающих справочников дополнительный фильтр можно

задать вместе со значением GR1 после знака '\'

Пример:

::::::::::::::::::::

TIP=P

GR1=2171\STRIH1\_CODPRODUCER=SYS\_CONTEXT\('ENVUN4','DOC12345\_EXPED'\)

::::::::::::::::::::

Здесь предполагается, что поле STRIH1\_CODPRODUCER уже включено в состав

полей справочника путем изменения текста запроса для типа 'P'.

Новые свойства справочника Univers и его карточек

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

У справочника Univers добавлено новое свойство: MainAttr

По аналогии с MenuAttr, оно содержит имя \(одной!\) секции настраиваемой карточки, которая должна открываться вместо стандартной карточки \(по кнопке "A"\)

Пример:

MainAttr=ATTR\_PRC

У настраиваемой карточки добавлены новые свойства:

ShowModal, ShowFullScreen, ShowStd, StdCaption

ShowModal=true

Карточка всегда отображается в отдельном \(модальном\) окне

ShowFullScreen=true

Модальное окно карточки появляется в полноэкранном режиме

ShowStd=true

Настраиваемая карточка показывается на вкладке,

а на предыдущей вкладке доступна стандартная карточка

StdCaption=Cartela generala

При включенном свойстве ShowStd настраивает заголовок вкладки,

на которой отображается стандартная карточка.

Кроме этого, добавлена возможность создавать новые, дополнительные вкладки

для настраиваемой карточки. Для этого служат следующие свойства:

TabCount, Tab?Caption, Tab?DetailHeight

TabCount=3

Количество дополнительных вкладок \(не считая основных\)

Может принимать значения от 0 до 9.

Tab1Caption=Preturi

Заголовок дополнительной вкладки \(число в имени свойства - номер вкладки,

причем Tab0Caption задает заголовок основной вкладки настраиваемой карточки\).

Tab2DetailHeight=121

Включает Detail грид на дополнительной вкладке и задает его высоту

\(число в имени свойства - номер вкладки\).

Рождественский подарок - две опции на карточку Univers

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Когда карточка появляется не под основным гридом Univers, а в отдельном окне, то к этому окну применимы новые опции.

Свойства добавляются в секции, описывающей карточку:

секция Cartela для стандартной карточки или соответствующая секция для настраиваемой карточки.

HideTopPanel - скрывает верхнюю панель с полями COD, CODVECHI, DENUMIREA.

Пример: HideTopPanel=true

FocusOnGrid - устанавливает фокус ввода при открытии карточки на грид\(это происходит также при включенной опции HideTopPanel\)

Пример:FocusOnGrid=true

Кроме того, напоминаю о существовании свойства DetailHeight,открывающего второй \(detail\) грид на настраиваемой карточке.

Пример:DetailHeight=121

Настройка ограничения доступа на изменение универсального справочника

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Теперь можно заблокировать от изменений отдельные разделы справочника и дать отдельным пользователям права на внесение изменений в отдельные разделы, в том числе заблокированные.

Инструкция:

1. Выполнить апгрейд базы до версии 370

2. Заполнить таблицу TMS\_UNIVLOCK блокирующими записями вида:

INSERT INTO TMS\_UNIVLOCK \(TIP,GR1,PERSON\) VALUES \('O','E','Vasea'\)

Для каждого блокируемого раздела указать фамилию ответственного.

3. Отдельным пользователям внести в InitSQL разрешающие записи вида:

INSERT INTO VUNIVUNLOCK \(TIP,GR1\) VALUES \('O','E'\)

Примечание:

~~~~~~~~~~~

- Если не указан GR1 - подразумевается любой GR1 при указанном типе.

- Если не указаны ни TIP, ни GR1 - подразумевается весь справочник.

19.10.2004

Добавлен новый тип справочника - CantInTara. Этот справочник позволяет вводить количество единиц какой-то упаковки и получать реальное количество согласно значениям таблицы TMS\_UMS \(VMS\_UMS\). Работает это так: перед выпадением справочника вызывается метод UN4UMS.FillTable из схемы UN4PUBLIC, который очищает таблицу UN4PUBLIC.XUMS и заполняет ее строками из VMS\_UMS,

относящимися к указанному коду Univers. Выпадающий справочник показывает именно эту таблицу UN4PUBLIC.XUMS, позволяя менять в ней только поле CANT. При выборе нужной строки введенное количество в этой строке умножается на значение поля CANT\_UM \(поле CANT из VMS\_UMS\) и результат вставляется в поле, из которого был вызван справочник.

Пример настройки справочника:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:::::::::::::::

LISTTYPE=CantInTara

FIELD\_COD=DTSC

:::::::::::::::

Примечание:

~~~~~~~~~~~

Параметр FIELD\_COD должен содержать имя поля, в котором находится код Univers, количество которого требуется вводить при помощи описанного справочника.

Появилась возможность настраивать параметры выпадающего справочника на полях типа SagiEdit по той же технологии, что и справочники гридов. Для этого реализована возможность визуального редактирования этих параметров, сохранения их в базе данных Oracle, загрузки и удаления.

Для визуального редактирования параметров выпадающего справочника нужно кликнуть мышкой по кнопке справа, удерживая нажатыми клавиши &lt;Ctrl&gt; и &lt;Alt&gt;, либо \(как для гридов\) нажать клавиши &lt;Alt&gt;+&lt;D&gt;.

Загрузить, сохранить и удалить параметры можно при помощи одноименных кнопок в правом нижнем углу окна редактирования параметров справочника.

Множественное выделение записей в универсальном справочнике

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В нижней части окна универсального справочника добавлена кнопка с изображением пачки документов и хинтом "Множественное выделение строк" нажав эту кнопку, можно одновременно выделить несколько строк справочника - для этого надо удерживать нажатой клавишу &lt;Ctrl&gt;

Множественное выделение строк справочника может быть использовано при перемещении групп строк в текущий узел группировки или исключении их из группировок вообще

------------------------------------------------------------------------------------------------------------

Для использования настройки выпадающего справочника в дизайне документа, созданного на базе 201, надо в Администраторе добавить свойство UsePickList типа Boolean и присвоить ему значение true:

UsePickList=true

------------------------------------------------------------------------------------------

Появилась возможность настраивать в дизайне грида параметры выпадающего справочника как произвольного SQL-запроса с использованием параметров.

Параметры справочника сохраняются в текстовом поле в INI-формате, но окно дизайна грида позволяет редактировать их визуально \(более наглядно\).

Ключевой параметр - TIP, значение которого определяет тип справочника.

Допустимые значения: U, S, P, I, i, M, Q.

Остальные параметры зависят от типа справочника:

Тип U \(справочник Univers\):

~~~~~~~~~~~~~~~~~~~~~~~~~~~

FIELD\_COD - поле, в котором сохраняется код Univers \(поле COD\)

FIELD\_CONT - счет или поле, в котором хранится счет

U\_FILTER\_LEVEL - уровень аналитики \(0: Sc, 1: Dep, 2:Sc1\)

U\_FILTER\_TIP - фильтр по полю TIP

U\_FILTER\_GR1 - фильтр по полю GR1

При указании FIELD\_CONT фильтр определяется из плана счетов с учетом

U\_FILTER\_LEVEL, а U\_FILTER\_TIP и U\_FILTER\_GR1 не используются.

При отсутствии параметра FIELD\_CONT фильтр определяется параметрами

U\_FILTER\_TIP и U\_FILTER\_GR1, а параметр U\_FILTER\_LEVEL не используется.

Примеры:

::::::::::::::::::::

TIP=U

FIELD\_COD=DTSC

FIELD\_CONT=DT

U\_FILTER\_LEVEL=0

::::::::::::::::::::

TIP=U

FIELD\_COD=CTDEP

FIELD\_CONT=5311

U\_FILTER\_LEVEL=1

::::::::::::::::::::

TIP=U

FIELD\_COD=SC\_PROD

U\_FILTER\_TIP=P

U\_FILTER\_GR1=2111

::::::::::::::::::::

Тип S \(справочник SysS\):

~~~~~~~~~~~~~~~~~~~~~~~~

FIELD\_COD - поле, в котором сохраняется код SysS \(обычно поле COD1\)

U\_FILTER\_TIP - фильтр по полю TIP

U\_FILTER\_GR1 - фильтр по полю COD

U\_SEL\_FIELD - ключевое поле \(по умолчанию COD1\)

Например, для выбора валюты U\_SEL\_FIELD должно иметь значение UM

Примеры:

::::::::::::::::::::

TIP=S

FIELD\_COD=CATEGOR

U\_FILTER\_TIP=R

U\_FILTER\_GR1=501

::::::::::::::::::::

TIP=S

FIELD\_COD=VALUTA

U\_FILTER\_TIP=S

U\_FILTER\_GR1=3

U\_SEL\_FIELD=UM

::::::::::::::::::::

Тип P \(справочник PDC\):

~~~~~~~~~~~~~~~~~~~~~~~

FIELD\_CONT - поле, в котором сохраняется счет

U\_FILTER\_CONTS - фильтр по счетам

Пример:

::::::::::::::::::::

TIP=P

FIELD\_CONT=CT

U\_FILTER\_CONTS=21 !217

::::::::::::::::::::

Типы I и i \(справочник UM\):

~~~~~~~~~~~~~~~~~~~~~~~~~~~

FIELD\_COD - поле, в котором сохраняется код единицы измерения

Выбор производится из запроса "SELECT ID\_UM,SHORT\_NAME,NAME FROM TMS\_UM"

Тип I означает визуальный выбор полного имени единицы измерения,

тип i означает визуальный выбор краткого имени единицы измерения.

Пример:

::::::::::::::::::::

TIP=I

FIELD\_COD=UM

::::::::::::::::::::

Тип M \(справочник по маске\):

~~~~~~~~~~~~~~~~~~~~~~~~~~~~

FIELD\_MASK -

FIELD\_COD -

U\_FILTER\_LEVEL -

Пример:

::::::::::::::::::::

TIP=M

FIELD\_MASK=

FIELD\_COD=

U\_FILTER\_LEVEL=

::::::::::::::::::::

Справочник по маске пока не документрован, так как маски не стандартизованы

Тип Q \(произвольный запрос\):

~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Текст запроса задается либо одной строкой как значение параметра SQL, либо в несколько строк группой параметров SQL1, SQL2, SQL3 и т.д.

LISTFIELDS - список полей запроса, подлежащих копированию значений  

RESULTFIELDS - список полей грида, в которые производится копирование

CAPTIONS - список заголовков столбцов

WIDTHS - список ширин столбцов

Примеры задания текста запроса:

::::::::::::::::::::

SQL=SELECT ID\_CONTRACT,CONTRACTNAME FROM VMS\_CONTRACT

::::::::::::::::::::

SQL1=SELECT ID\_CONTRACT,CONTRACTNAME FROM VMS\_CONTRACT

SQL2=WHERE TYPE=2 AND VALUTA&lt;&gt;'LEI'

::::::::::::::::::::

Как правило, дизайн выпадающего справочника сводится к заданию заголовков и ширин столбцов - используя параметры CAPTIONS и WIDTHS, можно избежать сохранения дизайна справочника и связанных с этим накладных расходов.

Для визуального сокрытия необходимого столбца можно задать ему ширину 0.

Пример задания дизайна справочника:

::::::::::::::::::::

CAPTIONS=,Контракт

WIDTHS=0,20

::::::::::::::::::::

Списки LISTFIELDS и RESULTFIELDS должны иметь ОДИНАКОВОЕ количество полей.

Списки CAPTIONS и WIDTHS могут иметь произвольное количество значений, недостающие значения будут заполнены значениями по умолчанию.

Списки LISTFIELDS и RESULTFIELDS можно не указывать - тогда копирование значений будет выполняться только для тех полей, которые имеют одинаковые имена в справочнике и в гриде. Это достигается указанием алиасов полей в тексте запроса справочника. Для указания алиаса поля, соответствующего объектному полю грида \(имя объектного поля содержит точку\), надо заменить

точку на символ подчеркивания.

Пример упрощения: первый список параметров вполне может быть заменен вторым

::::::::::::::::::::

TIP=Q

SQL=SELECT \* FROM VMS\_PRODUCT

LISTFIELDS=ID\_PRODUCT,PRODUCT\_NAME

RESULTFIELDS=CONTA.SC,CLCCONTA\_SCT

::::::::::::::::::::

TIP=Q

SQL=SELECT ID\_PRODUCT CONTA\_SC,PRODUCT\_NAME CLCCONTA\_SCT FROM VMS\_PRODUCT

::::::::::::::::::::

При этом значение поля ID\_PRODUCT \(с алиасом CONTA\_SC\) будет скопировано

в объектное поле CONTA.SC

В тексте запроса справочника можно использовать параметры, имена которых должны удовлетворять тем же правилам, что и имена параметров в Actions документов и форм \(см. ниже\).

Пример:

::::::::::::::::::::

TIP=Q

SQL=SELECT ID\_PRODUCT,PRODUCT\_NAME FROM VMS\_CONTRACT WHERE DOCID=:NRDOC

::::::::::::::::::::

------------------------------------------------------------------------------------------------------------------



Инструкция по настройке общего справочника произвольного типа

[https://docs.google.com/document/d/1cU68V4L5vsNUscOJPYqsTB9mkRz5K1j2eYT8O6miRF8/edit](https://docs.google.com/document/d/1cU68V4L5vsNUscOJPYqsTB9mkRz5K1j2eYT8O6miRF8/edit)

Создаем секцию в Администраторе в разделе "Настройки" \(можно в любом месте дерева, но желательно в разделе CustomList, находящемся на одном уровне с узлом "System settings"\)

Вот пример корневого узла CustomList:

\[CustomList\]

.Type=Univ group

.Parent=NULL

.IsGroup=1

.Caption=CustomList

Вот пример узла произвольного справочника:

\[cl\_contract\]

.Type=Univ group

.Parent=CustomList

.IsGroup=1

.Caption=cl\_contract

Для настройки выпадающего справочника на этот узел надо в окне настройки дизайна на вкладке "Dropdown list setup" выбрать тип справочника \(например, "SQL"\), а на вкладке "Other field properties" в поле "Section \(Administrator\)"  ввести имя секции узла произвольного справочника \(в нашем примере это cl\_contract\)

В текстовом просмотре свойств должно получиться так:

TIP=Q

TIPNODE=cl\_contract

Несмотря на то, что тип справочника можно выбрать любой,наибольший практический интерес представляет именно тип Q

Свойства справочника могут быть заданы несколькими способами Можно задать их прямо в окне редактирования дизайна, а можно задать их в Администраторе в секции узла.

Во втором случае они могут быть заданы один раз для всех случаев использования справочника. Зато задавая их прямо в окне дизайна, можно заменить общие для всех свойства конкретными отличающимися значениями  Имена свойств для задания в Администраторе можно узнать, задавая их визуально и затем просматривая в текстовом режиме.

Для справочника с произвольным запросом можно задать текст основного запроса как свойство "SQL" узла Администратора, а текст предварительного SQL \(Prepare SQL\) как свойство "PSQL". Свойства SQL и PSQL могут быть как типа "String", так и "Memo".  Для этого типа справочника тут можно задать также такие свойства, как ListFields, ResultFields, Captions и Widths \(соответственно текстовым полям на вкладке "List setup"\).

Кроме этого, целый ряд свойств справочника можно задать одним свойством "List" Администратора \(типа "Memo"\), если скопировать туда эти свойства из текстового режима окна настройки справочника. Так удобнее быстро создать общий справочник, но так не очень удобно исправлять отдельные свойства.

Наивысший приоритет будут иметь свойства, заданные в окне настройки свойств справочника, самый низший приоритет у свойств, заданных "всем скопом" в свойстве "List"

Для справочника с произвольным запросом можно задать основной или предварительный запрос с параметрами, расшифровку которых указать в конце текста соответствующего запроса в блоке комментария, располагая каждую расшифровку на отдельной строке, например:

SELECT CONTRACTID,INFO

FROM VCN0M\_CONTRACTS\_SHORT

WHERE \(CLIENTID = :CLIENT\)

/\*

client=field\_dmDG1\_sq04tDEP\_SECTIA

\*/

Вот как это выглядит в качестве свойства узла Администратора:

\[ZZZ\]

SQL=.MEMO.ZZZ.SQL

.type.SQL=Memo

\[.MEMO.ZZZ.SQL\]

SELECT CONTRACTID,INFO

FROM VCN0M\_CONTRACTS\_SHORT

WHERE \(CLIENTID = :CLIENT\)

/\*

/\*

client=field\_dmDG1\_sq04tDEP\_SECTIA

\*/

Но задание расшифровки на уровне узла Администратора

далеко не всегда удобно, удобнее размещать там только

запрос, а расшифровку указывать в каждом конкретном

случае использования справочника в его настройках.

Тогда в качестве свойства "SQL" узла Администратора

надо задать запрос без расшифровки или с частичной

расшифровкой \(только некоторых параметров\),

а в тексте запроса в окне настройки справочника

ввести только расшифровку остальных параметров

как блок комментария, начинающийся со строки /\*params

Например: свойство SQL Администратора содержит запрос

SELECT CONTRACTID,INFO

FROM VCN0M\_CONTRACTS\_SHORT

WHERE \(CLIENTID = :CLIENT\)

А в поле "SQL" в окне настроек справочника мы вводим

/\*params

client=field\_dmDG1\_sq04tDEP\_SECTIA

\*/

В текстовом режиме просмотра это должно выглядеть так:

SQL1=/\*params

SQL2=client=field\_dmDG1\_sq04tDEP\_SECTIA

SQL3=\*/

Если на уровне узла Администратора задано свойство "PSQL",

но в конкретном случае использования справочника нужно

отказаться от его использования, нужно в окне настроек

в поле "Prepare SQL" ввести символ восклицательного знака.

В текстовом режиме просмотра это должно выглядеть так:

PSQL=!

Для задания свойств произвольного запроса через XGRIDPROP

\(и в том числе для задания SQLInsert, SQLUpdate и т.п.\)

надо на уровне узла Администратора или на уровне окна

задать свойство "SagiEditQuery" значением "true" или "1".

При первом выпадении справочника просто исправить запрос

и сохранить, как обычно в таких случаях.  


-------------------------------------------------------------------

Чтобы univers подфильтровывался в зависимости от subset-а нужно:

1. пакеты: bg\_nrset, bg\_policy

2. полиси: UN4BG\_UN$PLC\_UNIVERS, UN4BG\_UN$PLC\_TMS\_UNIV\_LV2, UN4BG\_VMS\_NRSETM\_USER

3. tms\_nrset\_org и заполнить \(access\_level=0 =&gt; для этой организации фильтруется по нрсету. access\_level=1 =&gt; используется таблица исключений - см.формочку\)

\(id= id\_mask из vms\_nrsetm\)

4. tms\_univ\_nrset: в колонке nrset для каждого типа справочника указывается какой нрсет по умолчанию вставлять в универс при инсерте/апдейте, если он= Null.

если в этой таблице справочника нет, то в универс будет попадать текущий на тот момент нрсет

5. get\_univ\_nrset

6. TRIG\_BFINS\_TMS\_UNIVERS

select \* from session\_context where attribute = 'BG\_POLICYSTP\_UNIV\_LV2'

